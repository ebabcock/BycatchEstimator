<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Material from 2025 ICCAT Training Course • BycatchEstimator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Material from 2025 ICCAT Training Course">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BycatchEstimator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Course2025.html">Material from 2025 ICCAT Training Course</a></li>
    <li><a class="dropdown-item" href="../articles/InstallationGuide.html">Installing BycatchEstimator</a></li>
    <li><a class="dropdown-item" href="../articles/TransitionFrom2024Version.html">Transitioning to the new version of bycatchEstimator in 2025</a></li>
    <li><a class="dropdown-item" href="../articles/UserGuide2.html">BycatchEstimator User Guide</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Material from 2025 ICCAT Training Course</h1>
                        <h4 data-toc-skip class="author">Beth
Babcock</h4>
            
            <h4 data-toc-skip class="date">2025-08-13</h4>
      

      <div class="d-none name"><code>Course2025.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-and-agenda">Introduction and Agenda<a class="anchor" aria-label="anchor" href="#introduction-and-agenda"></a>
</h2>
<p>This document includes the slides and R tutorials from the ICCAT
BycatchEstimator training in Panama City, Panama in July, 2025. The
slides and tutorials are listed in the order they were presented.</p>
<p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:8be9a9ab-4cec-4358-8973-7cf1f8beaeaf" class="external-link">Agenda</a></p>
</div>
<div class="section level2">
<h2 id="presentation-1--overview-of-the-bycatchestimator-r-package">Presentation 1. Overview of the BycatchEstimator R Package<a class="anchor" aria-label="anchor" href="#presentation-1--overview-of-the-bycatchestimator-r-package"></a>
</h2>
<p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:e752e23f-2d42-4b73-8711-9c765cea9388" class="external-link">Slides
for overview</a></p>
</div>
<div class="section level2">
<h2 id="tutorial-1--introduction-to-the-bycatchestimator-tool">Tutorial 1. Introduction to the BycatchEstimator Tool<a class="anchor" aria-label="anchor" href="#tutorial-1--introduction-to-the-bycatchestimator-tool"></a>
</h2>
<div class="section level3">
<h3 id="install-and-load-the-library-">Install and load the library.<a class="anchor" aria-label="anchor" href="#install-and-load-the-library-"></a>
</h3>
<p>Start by loading the libraries, after installing them if needed. Note
that BycatchEstimator will open all the other libraries it needs,
including tidyverse. For more guidance, see here: <a href="https://ebabcock.github.io/BycatchEstimator/articles/InstallationGuide.html" class="uri">https://ebabcock.github.io/BycatchEstimator/articles/InstallationGuide.html</a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#devtools::install_github("ebabcock/BycatchEstimator")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="look-at-format-of-the-input-data-">Look at format of the input data.<a class="anchor" aria-label="anchor" href="#look-at-format-of-the-input-data-"></a>
</h3>
<p>For bycatch estimation, there are two data sources, the observer
data, which has one row per sample unit (sets or trips) and the logbook
data. For CPUE standardization, only the observer data is needed.</p>
<p>The package includes some simulated longline observer data from
LLSIM, and a toy example data set. This is the toy data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">obsdatExample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">obsdatExample</span><span class="op">)</span></span></code></pre></div>
<p>This is trip by trip observer data from a benthic longline fishery.
The variables we need are <em>Catch</em>, which is bycatch of a species,
<em>sampled.sets</em>, which is the unit of effort, and the variables
<em>Year</em>, <em>EW</em> and <em>season</em>, which will define the
stratification for the design-based estimate and serve as predictor
variables for the model-base estimates. CPUE would be in terms of
<em>Catch/sampled.sets</em>.</p>
<p>The corresponding logbook data is here:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">logdatExample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">logdatExample</span><span class="op">)</span></span></code></pre></div>
<p>The logbook data must include all the effort for which bycatch
estimates are needed (i.e.the whole fleet). This logbook data contains
one row per trip, the same as the observer data. The logbook data could
also be aggregated, with a column giving the sample size per row (here
<em>trips</em> is 1 for all rows). The logbook data must include effort
in the same units as the observer data (in this case <em>sets</em>), and
the same predictor variables (in this case <em>Year</em>, <em>EW</em>,
and <em>season</em>).</p>
</div>
<div class="section level3">
<h3 id="bycatchsetup">bycatchSetup<a class="anchor" aria-label="anchor" href="#bycatchsetup"></a>
</h3>
<p>The first step in bycatch estimation is setup the input file and
review and verify the data. Notice that returned value from
<code>bycatchSetup</code> is assigned as an object that will be used in
subsequent steps for applying design-based estimators
(<code>bycatchDesign</code>) and model fitting
(<code>bycatchFit</code>). This step produces output that is saved to
the working directory for the user to review. The inputs to the
<code>bycatchSetup</code> function are explained in the help file. To
see what the function does:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">bycatchSetup</span></span></code></pre></div>
<p>The help file explains all the inputs. Read through them to see what
options there are. The User’s Guide goes into much more detail.</p>
<p>For now, let’s run the simulated example data. First set the working
directory to where you want the outputs to be, for example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Commented out so it will not run, because every computer has a different path. </span></span>
<span><span class="co"># setwd("~/Tutorials")</span></span></code></pre></div>
<p>Now copy and paste this example to the console or an R script and run
it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatExample</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatExample</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"sampled.sets"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"sets"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="st">"Catch"</span>,</span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"EW"</span>,<span class="st">"season"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"Simulated"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"Simulated example species"</span>,</span>
<span>  common <span class="op">=</span> <span class="st">"Simulated species"</span>,</span>
<span>  sp <span class="op">=</span> <span class="st">"Genus species"</span>,</span>
<span>  reportType <span class="op">=</span> <span class="st">"html"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The tool has printed output files in the directory you specified with
baseDir and a subdirectory named runName. In this example, it created
the folder “OutputSimulated”, and inside that a subfolder named
“Simltdspcscatch”, which is an abbreviation of the species common name
and catch type. In the subfolder, you will find an html report with the
results, and another subfolder named “Setup files”.</p>
<p>The html file called “SimltdspcscatchDataChecks.html” contains
summary figures and tables showing the sample size and presence/absence
of the bycatch species across levels of predictor variables, observer
coverage levels, raw trends in CPUE, and a summary of the available
data. It also indicates if there are missing data or NAs with warning
messages at the top of the file. The tool also produced csv files inside
the “bycatchSetup files” folder. These contain data summaries by Year
and factor variables. For more information on these see Appendix in the
User Guide.</p>
<p>At this point, if the fishery and/or the observer coverage is low,
check to make sure that you have at least some positive observations in
each year. If any year has no positive observations, the delta models
will not work. This example has only 1 positive observation in each of
the last two years (2017 and 2018), so it will not crash, but we can
expect some models to perform badly. The last two columns of the data
summary table (Table 2) are a ratio estimator that is unstratified
(except by year) as a quick reality check on the expected magnitude of
the total bycatch (columns “Cat” and “Cse”).</p>
</div>
<div class="section level3">
<h3 id="bycatchdesign">bycatchDesign<a class="anchor" aria-label="anchor" href="#bycatchdesign"></a>
</h3>
<p>The <code>bycatchDesign</code> function generates design-based
estimates of total bycatch, e.g. using a stratified ratio estimator. You
don’t have to run this function if you are only using model-based
estimates (see below). The inputs to <code>bycatchDesign</code> are
explained in the help file:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">bycatchDesign</span></span></code></pre></div>
<p>You can use this code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>designScenario <span class="op">=</span> <span class="st">"withPooling"</span>,</span>
<span>designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>designVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"season"</span><span class="op">)</span>,</span>
<span>designPooling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>poolTypes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"adjacent"</span>,<span class="st">"all"</span><span class="op">)</span>,</span>
<span>pooledVar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>adjacentNum<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>minStrataUnit <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The tool has now printed another html file named
“SimltdspcscatchwithPoolingDesignResults.html”. The available estimator
types are a stratified ratio estimator, and a stratified design-based
delta-lognormal estimator. It also created the subfolder “Design files”,
which contain csv files with summaries and a file with “withPooling” in
the name, that gives some information about how much pooling was done.
In this example, pooling was only requested if there was less than one
sample unit (trip) and only to adjacent years and all season, which was
not enough to eliminate the zero estimates in some strata (see
SimltdspcscatchwithPoolingDesignStrata.csv). We will return to this
later.</p>
</div>
<div class="section level3">
<h3 id="bycatchfit">bycatchFit<a class="anchor" aria-label="anchor" href="#bycatchfit"></a>
</h3>
<p>The <code>bycatchFit</code> function does all the model-based
estimates.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">bycatchFit</span></span></code></pre></div>
<p>This function has a few more specifications regarding setting up
model variables, model selection (which information criterion to use),
use of random effects, etc. This function uses the information criteria
to find the best set of predictor variables for each kind of model
listed in modelTry. It can also do cross validation if desired. It
prints out the model based estimates, diagnostics, and selection
criteria.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>modelScenario <span class="op">=</span> <span class="st">"model1"</span>,</span>
<span>complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="op">(</span><span class="va">Year</span><span class="op">+</span><span class="va">season</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>indexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Delta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>,</span>
<span>randomEffects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>randomEffects2 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>VarCalc <span class="op">=</span> <span class="st">"Simulate"</span>,</span>
<span>useParallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>nSims <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>There will now be a html file named
“Simltdspcscatchmodel1ModelResults.html” in the output directory that
includes all the figures and plots. In addition, all the model outputs
are printed to .csv files for later use inside the folder “Fit
files”.</p>
</div>
</div>
<div class="section level2">
<h2 id="presentation-2--data-setup-and-data-checks">Presentation 2. Data setup and data checks<a class="anchor" aria-label="anchor" href="#presentation-2--data-setup-and-data-checks"></a>
</h2>
<p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:d96970ee-ffe1-4f29-ba58-61e2423d2058" class="external-link">Slides
for data</a></p>
</div>
<div class="section level2">
<h2 id="tutorial-2--data-setup-and-data-checks-with-the-bycatchsetup-function">Tutorial 2. Data setup and data checks with the bycatchSetup
function<a class="anchor" aria-label="anchor" href="#tutorial-2--data-setup-and-data-checks-with-the-bycatchsetup-function"></a>
</h2>
<p>This tutorial explains what outputs are produced after running
bycatchSetup and how to interpret them (what to look out for in terms of
potential issues with the data). First load the libraries:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("ebabcock/BycatchEstimator")  #Make sure library is installed and up to date</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>We will use simulated longline data from Phil Goodyear’s species
distribution and longline fishery simulator. The data in both the
logbook and observer data are at trip-by-trip. There is a variable
called <em>trip</em> which can be used to match the sampled trips in the
observer data to the corresponding trips in the logbook.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_observer</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_logbook</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s run bycatchSetup with the following arguments:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">LLSIM_BUM_Example_observer</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">LLSIM_BUM_Example_logbook</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin catch</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area"</span>,<span class="st">"fleet"</span>,<span class="st">"season"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"hbf"</span><span class="op">)</span>, <span class="co">## add some numeric variables to show in plots</span></span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMSetup"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm BUM"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># selecting Blue marlin</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Have a look at the html file with the results “Blue marlin Data
checks”. This output starts with a section that contains Data warnings.
The tool will print out warnings if there are NAs in either observer or
logbook data; if there are levels of factor variables present in the
observer data but not in the logbook data (and vice-versa); and if the
range of each numeric variable is not consistent between observer and
logbook data (points more than 5% outside the range of values). Zero
values of effort in the observer data also give a warning. This example
has no warnings or errors.</p>
<p>Next there are Summary Tables. Table 1 shows a comparison of total
sample units (trips or sets) and effort units between observer and
logbook data, and the proportion of sample units and effort units. Table
2 gives a data summary for each year, including effort and sample units
in both logbook and observer data, mean CPUE with standard error, number
of outliers. For more details on each column see the Appendix in the
User Guide. The columns “Cat” and “Cse” contain estimated catch using a
unstratified ratio estimator and corresponding standard error.</p>
<p>The following section contains figures comparing observer vs. logbook
effort, sample units and variables. These figures allow you to see if
there any large discrepancies between observer and logbook data.</p>
<ul>
<li><p>Figure 1: barplot of total effort comparison for each factor
variable and corresponding factor levels</p></li>
<li><p>Figure 2: barplot of total number of trips for each factor
variable and corresponding factor levels</p></li>
<li><p>Figure 3: total number of trips for each numeric variable (effort
included)</p></li>
<li><p>Figure 4: diagonal shows histograms/density plot for each numeric
variable, which represent the distribution of each variable; lower
triangle shows scatterplots for each pair of variables, allowing to spot
correlations or outliers; upper triangle shows correlation
coefficients</p></li>
<li><p>Figure 5: diagonal shows frequency/counts for each factor level;
lower and upper triangle shows mosaic plot for each pair of variables,
where the size/area of each bar is proportional to the number of
observations in each level</p></li>
</ul>
<p>There are also barplots showing presence/absence of the bycatch
species in the observer data by year and by level of categorical and
numeric variables (Figures 6 - 8); total catch in the observer data by
factor and numeric variables (Figures 9); catch per sample unit in
observer data by factor and numeric variables (Figures 10 - 12); and
catch per unit effort (CPUE) in observer data by factor and numeric
variables, including the effort variable (Figures 14 - 16).</p>
<p>Model-based estimation methods work when there are non-zero catches
across all levels of each variable. Numerical variables can introduce
bias if the observed data does not include the full range of values in
the whole fishery. Also, check for instances of very high CPUE. This may
happen if a catch occurs in a set/trip with low recorded effort, and
these outliers may bias the results.</p>
<p>Design-based estimates require observations in all strata. If there
are any strata with no observations, consider pooling.</p>
</div>
<div class="section level2">
<h2 id="presentation-3--design-based-estimation">Presentation 3. Design-Based estimation<a class="anchor" aria-label="anchor" href="#presentation-3--design-based-estimation"></a>
</h2>
<p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:6a0e09e6-b0da-4849-89f5-b8b8b3892add" class="external-link">Slides
for design-based</a></p>
</div>
<div class="section level2">
<h2 id="tutorial-3--design-based-estimation-with-the-bycatchdesign-function">Tutorial 3. Design-based estimation with the bycatchDesign
function<a class="anchor" aria-label="anchor" href="#tutorial-3--design-based-estimation-with-the-bycatchdesign-function"></a>
</h2>
<p>This tutorial gives some practice in working with design-based
estimators, including different pooling methods, using the data sets
included with the tool. First load the libraries:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("ebabcock/BycatchEstimator")  #Make sure library is installed and up to date</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>To understand how stratified estimators work, let’s stratify by year,
fleet and area (N vs. S Atlantic). The bycatch response variable is the
catch of blue marlin <em>BUM</em> and effort is in <em>hooks</em>. Run
first <code>bycatchSetup</code> for setting up the data, using the
simulated longline data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">LLSIM_BUM_Example_observer</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">LLSIM_BUM_Example_logbook</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin catch</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area"</span>,<span class="st">"fleet"</span>,<span class="st">"month"</span>,<span class="st">"season"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUM"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIMBUM"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># selecting Blue marlin</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="with-no-pooling">With no pooling<a class="anchor" aria-label="anchor" href="#with-no-pooling"></a>
</h3>
<p>And then run <code>bycatchDesign</code>, first with no pooling:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  designScenario <span class="op">=</span> <span class="st">"NoPooling"</span>,</span>
<span>  designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>  designVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  designPooling <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can have a look at the html file “Blue marlin catch Design-based
estimation results” with the results. Within the folder “bycatchDesign
files”, there is a file called “designStrata”, which summarizes the
design-based estimates by stratification variables. If you open the file
called designStrata, you can see that some strata have zero estimates.
This may mean that those combinations of the designVars <em>Year</em>,
<em>season</em> and <em>area</em> have effort in the logbooks, but are
not sampled by observers. You can also see these zero estimates in the
csv file “StrataSummary” produced in <code>bycatchSetup</code>. In here,
you see that in these strata, there is logbook effort but no observer
effort. We can resolve this by pooling. We need to add some more inputs
to define the pooling.</p>
</div>
<div class="section level3">
<h3 id="with-pooling">With pooling<a class="anchor" aria-label="anchor" href="#with-pooling"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  designScenario <span class="op">=</span> <span class="st">"Pool2"</span>, <span class="co">#update name</span></span>
<span>  designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>  designVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  designPooling <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#Make this TRUE</span></span>
<span>  poolTypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"adjacent"</span>,<span class="st">"all"</span>,<span class="st">"all"</span><span class="op">)</span>,  <span class="co">#Pool by adjacent years, and all fleets or all areas</span></span>
<span>  pooledVar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,  <span class="co">#Pool variables in this order</span></span>
<span>  adjacentNum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,  <span class="co">#Pool 2 years before and after</span></span>
<span>  minStrataUnit <span class="op">=</span> <span class="fl">2</span>,  <span class="co">#Pool if there are 2 or fewer trips in a stratum</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this example, we pooled by year, area and fleet, in that order. If
a stratum had less than or equal to minStrataUnit=2 trips, we pooled
with the two years before and after, for a total of 5 years. The file
called “Pooling.csv” gives details on how the pooling worked in each
stratum, this is also shown in a figure in designResults. The column
<em>poolnum</em> gives the level of pooling, where 1 is just the first
variable (Year), 2 is the second variable, etc. The column
<em>pooled.n</em> give the sample size in the pool for that stratum,
which can be the same as the observed n in the stratum, if n was above
the minimum. For example, look at <em>Year</em> 1996, <em>fleet</em> 3,
and <em>area</em> N.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pooling</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUM/Bluemarlincatch/Design files/BluemarlincatchPool2Pooling.csv"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pooling</span><span class="op">)</span></span>
<span><span class="va">pooling</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">poolnum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Pooling</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&gt;"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">poolnum</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,<span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,fill<span class="op">=</span><span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Count of strata per year with number of dimensions pooled"</span><span class="op">)</span></span>
<span><span class="co">#pull out an exmple</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pooling</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1994</span><span class="op">:</span><span class="fl">2000</span>, <span class="va">fleet</span><span class="op">==</span><span class="fl">3</span>, <span class="va">area</span><span class="op">==</span><span class="st">"N"</span><span class="op">)</span></span></code></pre></div>
<p>You can see that years 1996 and 1998 both needed to be pooled
(<em>units</em> of 2 or less). There was no effort in 1994 or 1995 in
this area and fleet. So the pool for year 1996 was 1996 to 1997, which
gave a pooled sample size (<em>pooled.n</em>) of 2+3+1=6. This was above
minStrataUnit, so that pool was sufficient and <em>poolnum</em> was one,
meaning no further pooling. Does the <em>pooled.n</em> value for 1998
make sense?</p>
<p>Let’s look at a stratum that needed more pooling.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pooling</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2006</span>, <span class="va">fleet</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>This fleet had one trip in the area in 2003, and zero in 2002 and
2004, so combining years did not give enough trips for a pool for the
2004 estimate. So, <em>poolnum</em> is 2, and the <em>pooled.n</em>
includes all areas for that fleet in that year.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_observer</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2006</span>,<span class="va">fleet</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The html file shows what fraction of the strata are pooled to each
level as a diagnostic that the pooling works as intended (last
figure).</p>
</div>
<div class="section level3">
<h3 id="with-pooling-and-a-higher-minimum-catch-threshold">With pooling and a higher minimum catch threshold<a class="anchor" aria-label="anchor" href="#with-pooling-and-a-higher-minimum-catch-threshold"></a>
</h3>
<p>Now try the pooling for a higher minimum number of observed
trips:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  designScenario <span class="op">=</span> <span class="st">"Pool5"</span>, <span class="co">#update name</span></span>
<span>  designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>  designVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  designPooling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  poolTypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"adjacent"</span>,<span class="st">"all"</span>,<span class="st">"all"</span><span class="op">)</span>, </span>
<span>  pooledVar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  adjacentNum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>  minStrataUnit <span class="op">=</span> <span class="fl">5</span> <span class="co">#Pool if there are 5 or fewer trips in a stratum</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pooling</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUM/Bluemarlincatch/Design files/BluemarlincatchPool5Pooling.csv"</span><span class="op">)</span> </span>
<span><span class="va">pooling</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">poolnum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Pooling</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&gt;"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">poolnum</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,<span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,fill<span class="op">=</span><span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Count of strata per year with number of dimensions pooled"</span><span class="op">)</span></span></code></pre></div>
<p>You can compare the last plot in the html file with the previous
results when pooling with minStrataUnit=2.</p>
<p>Another option for pooling is to add another column to the data that
is a more aggregated variable to use when the original data doesn’t meet
the minimum sample size requirement. For example, if the strata were
months, the variable to pool on (if needed) could be season. Let’s try
that.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  designScenario <span class="op">=</span> <span class="st">"PoolMonth"</span>, <span class="co">#update name</span></span>
<span>  designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>, <span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>  designVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span>, <span class="st">"month"</span><span class="op">)</span>, <span class="co">#added month as design variable</span></span>
<span>  designPooling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  poolTypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"adjacent"</span>,<span class="st">"all"</span>,<span class="st">"all"</span>,<span class="st">"pooledVar"</span><span class="op">)</span>, </span>
<span>  pooledVar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span>,<span class="st">"season"</span><span class="op">)</span>,</span>
<span>  adjacentNum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>  minStrataUnit <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pooling</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUM/Bluemarlincatch/Design files/BluemarlincatchPoolMonthPooling.csv"</span><span class="op">)</span> </span>
<span><span class="va">pooling</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">poolnum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Pooling<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Pooling</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"&gt;"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">poolnum</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,<span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,fill<span class="op">=</span><span class="va">Pooling</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Count of strata per year with number of dimensions pooled"</span><span class="op">)</span></span></code></pre></div>
<p>This stratification scheme requires pooling for nearly all the
strata. It still works, but the resulting estimates will be somewhat
smoothed by the pooling process.</p>
</div>
</div>
<div class="section level2">
<h2 id="presentation-4--model-based-estimation-and-diagnostics">Presentation 4. Model based estimation and diagnostics<a class="anchor" aria-label="anchor" href="#presentation-4--model-based-estimation-and-diagnostics"></a>
</h2>
<ol style="list-style-type: lower-alpha">
<li><p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:6a98600b-6d94-4ec5-8d85-b7b7215be24c" class="external-link">Slides
for model-based estimation</a></p></li>
<li><p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:f0098ac0-ef29-4695-a95e-c970e201a060" class="external-link">Slides
for model diagnostics and model comparison</a></p></li>
</ol>
</div>
<div class="section level2">
<h2 id="tutorial-4-model-fitting-model-selection-and-diagnostics-with-bycatchfit">Tutorial 4: Model fitting, model selection and diagnostics with
bycatchFit<a class="anchor" aria-label="anchor" href="#tutorial-4-model-fitting-model-selection-and-diagnostics-with-bycatchfit"></a>
</h2>
<p>This tutorial will run the model fit function and then evaluate model
selection and diagnostics, including:</p>
<ul>
<li>Checking that the model was able to fit at all and using
cross-validation to compare the best model in each group.</li>
<li>Selecting predictor variables using information criteria within each
group of models.</li>
<li>Checking model diagnostics, such as quantile residuals.</li>
<li>Comparing bycatch predictions from the best model in each
group.</li>
<li>Choosing the best model.</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("ebabcock/BycatchEstimator")  #Make sure library is installed</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ardata-fr.github.io/flextable-book/" class="external-link">flextable</a></span><span class="op">)</span></span></code></pre></div>
<p>Model fitting and model selection can be slow. So, for the purposes
of this demonstration, we will limit the data to a 5 year period so it
will run faster.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obsdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_observer</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span>
<span><span class="va">logdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_logbook</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span></code></pre></div>
<p>To try multiple models, we define them in modelTry in
<code>bycatchFit</code>. The input modelTry is the list of model types
to fit and possibly compare with cross-validation. These are explained
in the <code>bycatchFit</code> help file. If the model type starts with
TMB, it will be fit in Template Model Builder using the glmmTMB library,
otherwise they are fit using other R libraries, including ordinary lm or
glm. Results for Tweedie vs. TMBtweedie, or NegBin vs. TMBnbinom2 should
be identical.</p>
<p>The inputs complexModel and simpleModel give the range of models to
be evaluated with information criteria in each model group. The
simpleModel should not include any interactions.</p>
<p>First run again <code>bycatchSetup</code> with the 5 years of
data:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin catch</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"season"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMModel1"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm BUM with model comparison"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># selecting Blue marlin</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co"># selecting Blue marlin</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now run <code>bycatchFit</code>. The input setupObj is the output
from <code>bycatchSetup</code>. The selectCriteria will be used to
select the best combination of predictor variables. This may be any of
the criteria for ranking models in the MuMIn dredge function. Bayesian
information criterion (BIC) works well.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"scen1"</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">season</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span> <span class="op">+</span><span class="va">area</span><span class="op">:</span><span class="va">season</span><span class="op">)</span>, <span class="co">#upper range of models to compare with information criteria,</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, <span class="co">#lower range of models to compare,</span></span>
<span>  indexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom1"</span>,<span class="st">"NegBin"</span>,<span class="st">"TMBnbinom2"</span>,<span class="st">"TMBtweedie"</span><span class="op">)</span>, <span class="co">#model types to compare</span></span>
<span>  randomEffects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  randomEffects2 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As the model is running, it prints out some text about how the models
are being selected, which you can ignore. It is done when it says “1
Blue marlin complete” along with the time. Tables and figures are all
printed to an html file called “Bluemarlincatchscen1Modelresults”, along
with .csv files with all the data for all the figures and tables inside
the folder “Fit files”.</p>
<p>The first section of the html output gives a review of the input
settings for model-based estimation (arguments defined in
<code>bycatchFit</code>). The second section gives the results of model
comparison.</p>
<p>Table 1 shows if the models were able to fit and summary results of
cross-validation that compared the best model across groups in terms of
their ability to predict CPUE. The best model was defined has having
lowest RMSE (root mean squared error) and ME (mean error) closest to
zero. For delta models, like delta-lognormal, both the binomial and
lognormal models are used together to predict CPUE, so the binomial
model doesn’t have it’s own value in the table. The last column
“Failure” checks if models were able to fit (this is shown only in the
html version of Table 1). It will have a dash if the model was able to
fit successfully. If the model was not able to fit, there will be a word
saying the model failed due to “data” (meaning that that the model was
not able to fit the delta models due to all zero all all non-zero
observations), “fit” (meaning the model never converged) or “CV”
(meaning predicted CVs were too large).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crossval</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/scen1crossvalSummary.csv"</span><span class="op">)</span></span>
<span><span class="va">crossval</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>,<span class="va">round</span>,digits<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">flextable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Figure 2 in the html file shows boxplots of RMSE and ME across 10
folds of the cross validation. The RMSE and ME values are very similar
between models but the delta-lognormal has the lowest RMSE. The csv
files called “scen1rmse.csv” and “scen1me.csv” have the numbers to
recreate these figures.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rmse</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/scen1rmse.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">TMBdelta.Lognormal</span><span class="op">:</span><span class="va">TMBtweedie</span>, names_to<span class="op">=</span><span class="st">"Model"</span>, values_to<span class="op">=</span><span class="st">"RMSE"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rmse</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Model</span>,y<span class="op">=</span><span class="va">RMSE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">me</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/scen1me.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">TMBdelta.Lognormal</span><span class="op">:</span><span class="va">TMBtweedie</span>, names_to<span class="op">=</span><span class="st">"Model"</span>, values_to<span class="op">=</span><span class="st">"ME"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">me</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Model</span>,y<span class="op">=</span><span class="va">ME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Table 2 gives a summary of model diagnostics. The diagnostics include
a test of whether the quantile residuals are uniformly distributed (KS),
an overdispersion test, a zero inflation test and an outlier test. In
all cases, signficant P values indicate potential problems. As usual
with hypothesis tests like this, the Null hypothesis is that the data do
not have the problem, so that larger datasets are more likely to find
significant P values. At the same time, larger datasets are more robust
to minor violations of model assumptions. In this case, negative binomal
2/NegBin and delta lognormal pass all the tests, and negative binomial 1
and Tweedie have some failures.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagnostics_summary</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/scen1modelSummary.csv"</span><span class="op">)</span></span>
<span><span class="va">diagnostics_summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>,<span class="va">round</span>,digits<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">flextable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Table 3 provides parameter values from the fitted models, together
with the likelihood and residuals degrees of freedom.</p>
<p>Figure 1 shows a time series of the total bycatch estimates from all
valid models, with a 95% confidence interval calculated by the chosen
variance calculation method. If no variance is calculated, there will be
no confidence interval shown. If any models are very different from the
others, that may indicate that not all models are consistent with the
data.</p>
<p>The third section of the html output gives results for each model
type. The tables in this section show model selection tables that select
predictor variables using information criteria within each model type
listed in modelTry. Previously in Table 1, it was shown the formula for
the BIC best model in each model type. Model selection tables give the
information criteria for the models, sorted from best to worst, along
with model weights calculated from the informatrion criterion selected
(BIC). The r-squared values are also shown. If there were two models
with similar weight, both might be viable.</p>
<p>For example, for the Negative Binomial model (NegBin), the best model
includes area, fleet and year. We can see the ranking of other models in
the file labelled “modelSelectionNegbin.csv”.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">negBinSel</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/Bluemarlincatchscen1ModelSelectionNegBin.csv"</span><span class="op">)</span></span>
<span><span class="va">negBinSel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">offset.log.Effort..</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>,<span class="va">round</span>,digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">flextable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The html output has a four panel residual plot for each model type
(example Figure 3 that shows residuals for TMBbinomial). The four panels
are: (a) ordinary residuals, i.e plotting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>−</mo><mover><mi>y</mi><mo accent="true">̂</mo></mover></mrow><annotation encoding="application/x-tex">y-\hat{y}</annotation></semantics></math>
against
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>y</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math>,
(b) the qqnormal plot of the ordinary residuals, (c) a qquniform plot of
the quantile residuals, and (d) quantile residuals against model
predictions. Part c and d are the plots generated by the DHARMa library.
The residuals are calculated by simulating data from the defined model
and likelihood function and calculating the quantile calculated from
each data point. If the model is adequately specified, the scaled
residuals should be uniformly distributed between 0 and 1. This will be
seen in all the points following the line in the qq plot, and all the
median, 25th and 75th percentiles (red lines in d are a smooth) being
horizontal and in the right place. The ordinary residuals are only
appropriate for normal or lognormal models. For models with complex
variance functions or integer responses (binomial and negative binomial)
the quantile residuals are more appropriate.</p>
<p>The next figures shows observed vs predicted values for each model
type, with a correlation test p-value and a smoothed trend line (example
Figures 5, 8, 11, 14).</p>
<p>The last figure for each model type are the bycatch predictions from
the best model in each model type. These are also saved as csv files
labelled “AnnualSummary”.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ResultsNegBin</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMM1/Bluemarlincatch/Fit files/Bluemarlincatchscen1NegBinAnnualSummary.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ResultsNegBin</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">Total</span>,ymin<span class="op">=</span><span class="va">TotalLCI</span>,ymax<span class="op">=</span><span class="va">TotalUCI</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p>Choosing the best model: it is not possible to completely automate
the problem of model selection. In this case, all models performed very
similarly in cross validation, and the DIC preferred the same
combination of predictor variables for all models. The models produced
quite similar results, so choosing any one of them would be a reasonable
choice.</p>
</div>
<div class="section level2">
<h2 id="presentation-5--cpue-standardization">Presentation 5. CPUE Standardization<a class="anchor" aria-label="anchor" href="#presentation-5--cpue-standardization"></a>
</h2>
<p><a href="https://acrobat.adobe.com/id/urn:aaid:sc:US:09faa7de-b6e6-4a1d-ad52-fea52696bad3" class="external-link">Slides
for CPUE standardization</a></p>
</div>
<div class="section level2">
<h2 id="tutorial-5--cpue-standardization-with-bycatchfit">Tutorial 5. CPUE Standardization with bycatchFit<a class="anchor" aria-label="anchor" href="#tutorial-5--cpue-standardization-with-bycatchfit"></a>
</h2>
<p>Although the BycatchEstimator package was originally developed for
bycatch estimation, it can also produce a CPUE index of abundance. For
this exercise we will turn off bycatch estimation. We will use the LLSIM
blue marlin data. The following models will show how to:</p>
<ol style="list-style-type: decimal">
<li><p>Compare model types.</p></li>
<li><p>Add random effects</p></li>
<li><p>Add more variables.</p></li>
</ol>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("ebabcock/BycatchEstimator")  #Make sure library is installed</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<p>Model fitting and model selection can be slow. So, for the purposes
of this demonstration, we will limit the data to a 15 year period so it
will run faster.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obsdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_observer</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2001</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span>
<span><span class="va">logdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_logbook</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2001</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="compare-model-types-">1. Compare model types.<a class="anchor" aria-label="anchor" href="#compare-model-types-"></a>
</h3>
<p>To set up the model for index estimation only, the argument
EstimateBycatch can be FALSE in <code>bycatchSetup</code>, if there is
no logbook data to be included. Note that all variables to be included
in the CPUE standardization must be included in numericVariables or
factorVariables:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="cn">NULL</span>, <span class="co">#no logbook data</span></span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="st">"BUM"</span>,</span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"season"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># no bycatch estimation</span></span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMCPUE1"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm BUM CPUE"</span>,</span>
<span>  common <span class="op">=</span> <span class="st">"Blue marlin"</span>,</span>
<span>  sp <span class="op">=</span> <span class="st">"Makaira nigricans"</span>,</span>
<span>  reportType<span class="op">=</span><span class="st">"html"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In <code>bycatchFit</code>, set the EstimateIndex argument to TRUE.
The formula in indexModel gives the variables to be kept separate in the
index. This will always include Year. If you need separate indices by
fleet or area, include them here. Note that the best model in between
simpleModel and complexModel will be used to generate the index, and
this may have different variables. Generally, the index will be
calculated at the mean value of any numerical predictor variables, and
at the most common level of any factors. If a variable, such as area, is
included in indexModel but not in the selected best model according to
the information criteria, the areas will all have the same index:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"scen1"</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">season</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">+</span><span class="va">area</span><span class="op">:</span><span class="va">season</span><span class="op">)</span>, <span class="co">#upper range of models to compare with information criteria,</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, <span class="co">#lower range of models to compare,</span></span>
<span>  indexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">)</span>, <span class="co">#Variables to include in index</span></span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBdelta-Gamma"</span>,<span class="st">"TMBnbinom2"</span>,<span class="st">"TMBtweedie"</span><span class="op">)</span>, <span class="co">#model types to compare</span></span>
<span>  randomEffects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  randomEffects2 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="cn">NULL</span>,  <span class="co">#Index standardaization doesn't use this</span></span>
<span>  EstimateIndex <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># index estimation</span></span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  reportType <span class="op">=</span> <span class="st">"html"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, looking at the html output, there will be no total bycatch
estimates, but there will be abundance indices plotted, plus and minus a
standard error. The results are also in a .csv file.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbinom2Index</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUMCP/Bluemarlincatch/Fit files/Bluemarlincatchscen1TMBnbinom2Index.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nbinom2Index</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">Index</span>,ymin<span class="op">=</span><span class="va">lowerCI</span></span>
<span>,ymax<span class="op">=</span><span class="va">upperCI</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">area</span><span class="op">~</span><span class="va">.</span><span class="op">)</span></span></code></pre></div>
<p>We can see that all the models have similar diagnostics, but imply
somewhat different trends.</p>
</div>
<div class="section level3">
<h3 id="add-random-effects">2. Add random effects<a class="anchor" aria-label="anchor" href="#add-random-effects"></a>
</h3>
<p>CPUE standardization models commonly include random effects, for
example to handle interactions between Year and other variables. It is
also worthwhile to include fishing vessel as a random effect when using
sets as a sample unit, to deal with the grouping in the data. Let’s try
Year:area as a random effect. Of course, random effects can also be used
for bycatch estimation, but this is less commonly done. If random
effects are included, they will be automatically included in all models.
randomEffects is the list of random effects to include in the model. For
delta models, randomEffects2 can be used to give a different set of
randomEffects for the two model components.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"s2randomeff"</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">season</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">+</span><span class="va">area</span><span class="op">:</span><span class="va">season</span><span class="op">)</span>, <span class="co">#upper range of models to compare with information criteria,</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, <span class="co">#lower range of models to compare,</span></span>
<span>  indexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">)</span>, <span class="co">#Variables to include in index</span></span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBdelta-Gamma"</span>,<span class="st">"TMBnbinom2"</span>,<span class="st">"TMBtweedie"</span><span class="op">)</span>, <span class="co">#model types to compare</span></span>
<span>  randomEffects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year:area"</span><span class="op">)</span>,</span>
<span>  randomEffects2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year:area"</span><span class="op">)</span>,</span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  EstimateIndex <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># index estimation</span></span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  reportType <span class="op">=</span> <span class="st">"html"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="add-more-variables-">3. Add more variables.<a class="anchor" aria-label="anchor" href="#add-more-variables-"></a>
</h3>
<p>For CPUE standardization, it may be desirable to add more variables,
such as gear variables and environmental variables. Numerical variables
will be set to their mean for the prediction. Here we add two numerical
variables (hbf and habBUM) and more factors (light).</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>, <span class="co">#no logbook data</span></span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="st">"BUM"</span>,</span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,</span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"season"</span>,<span class="st">"area"</span>,<span class="st">"light"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hbf"</span>,<span class="st">"habBUM"</span><span class="op">)</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># no bycatch estimation</span></span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMCPUE3"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm BUM CPUE more variables"</span>,</span>
<span>  common <span class="op">=</span> <span class="st">"Blue marlin"</span>,</span>
<span>  sp <span class="op">=</span> <span class="st">"Makaira nigricans"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"morevar"</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">season</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">+</span><span class="va">light</span><span class="op">+</span><span class="va">hbf</span><span class="op">+</span><span class="va">habBUM</span><span class="op">)</span>, <span class="co">#upper range of models to compare with information criteria,</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, <span class="co">#lower range of models to compare,</span></span>
<span>  indexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">)</span>, <span class="co">#Variables to include in index</span></span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBdelta-Gamma"</span>,<span class="st">"TMBnbinom2"</span>,<span class="st">"TMBtweedie"</span><span class="op">)</span>, <span class="co">#model types to compare</span></span>
<span>  randomEffects <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  randomEffects2 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  EstimateIndex <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># index estimation</span></span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  reportType <span class="op">=</span> <span class="st">"html"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this case the trends differ somewhat, perhaps in part because the
IC selected different predictor variables for different models.</p>
</div>
</div>
<div class="section level2">
<h2 id="tutorial-6--advanced-and-specialized-model-features-with-bycatchfit">Tutorial 6. Advanced and specialized model features with
bycatchFit<a class="anchor" aria-label="anchor" href="#tutorial-6--advanced-and-specialized-model-features-with-bycatchfit"></a>
</h2>
<p>This tutorial has some advanced and specialized methods:</p>
<ol style="list-style-type: lower-alpha">
<li><p>Running more than one species at once.</p></li>
<li><p>Matching trips to estimate bycatch in unsampled effort
only.</p></li>
<li><p>Making year a number, polynomial regression on year, or leaving
year out of the model.</p></li>
<li><p>Validation data.</p></li>
<li><p>Reading in the R objects with .rds files</p></li>
</ol>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("ebabcock/BycatchEstimator")  #Make sure library is installed</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ebabcock.github.io/BycatchEstimator/">BycatchEstimator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MuMIn</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="va">obsdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_observer</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span>
<span><span class="va">logdatTest</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">LLSIM_BUM_Example_logbook</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="a--running-more-than-one-species-at-once-">a. Running more than one species at once.<a class="anchor" aria-label="anchor" href="#a--running-more-than-one-species-at-once-"></a>
</h3>
<p>To run multiple species or catch types (e.g. bycatch vs. catch) at
once, all species must have their own column in the observer data. The
inputs common, sp, obsCatch, and catchType will be vectors to run
multiple species or catch types. All these vectors must have the same
length. Running multiple species together only works if you want to use
the same variables and model set up for each species. The information
criteria and cross validation may select different models for each
species.</p>
<p>We will run both blue marlin and swordfish together.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span>, <span class="co">#Column name vector</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>, <span class="co">#Will be replicated if one number is given</span></span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>, <span class="co">#Will be replicated if one number is given</span></span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMSWO"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm blue marlin and swordfish"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span>, <span class="co">#common name vector</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span> <span class="co">#scientific name vector</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>There are now folders for each species inside the output folder
labelled “OutputLLSIMBUMSWO”. Inside the folders for each species you
will find the html output with the data checks. Now copy and paste the
following code to the console:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"multispp"</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>, <span class="co">#model types to compare</span></span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">)</span>,</span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, </span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,   </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The model runs a loop with the two species, so you will see a
notification when each species finishes. This might take some time. All
the results are in separate folders for each species.</p>
</div>
<div class="section level3">
<h3 id="b--matching-trips-to-estimate-bycatch-for-unsampled-effort">b. Matching trips to estimate bycatch for unsampled effort<a class="anchor" aria-label="anchor" href="#b--matching-trips-to-estimate-bycatch-for-unsampled-effort"></a>
</h3>
<p>If it is possible to match individual trips in the observer and
logbook data, and the observed effort is less than the total effort, you
can predict only unobserved effort. If observers include only part of
the effort in a trip, the data can include both observed and unobserved
effort. For the LLSIM data, the matching variable is the trip ID. You
must now specify, includeObsCatch, and matchColumn. The code will
calculate the unsampled effort in each trip as the logbook effort minus
the observed effort. This must be non-zero (i.e. logbook effort equal to
or greater than observed effort). All trips from obsdat must match trips
in logdat. Let’s re-run bycatchSetup with only one species, then run
bycatchFit</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co">#choosing only one species</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>, </span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>, </span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUM"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIMBUM"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co">#choosing only one species</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co">#choosing only one species</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"matchtrips"</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">)</span>,</span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, </span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  includeObsCatch <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#True to include observed catch as a constant</span></span>
<span>  matchColumn <span class="op">=</span> <span class="st">"trip"</span>, <span class="co">#Must have the same name in obsdat and logdat</span></span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,   </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The tool will produce warning messages if there are observer trips
missing in the logbook data, and if there are negative values in the
calculated observed effort. The variance of the estimated total bycatch
when matching trips is now slightly lower. However, with an observer
coverage of only 5% there isn’t much difference.</p>
</div>
<div class="section level3">
<h3 id="c--making-year-a-number-polynomial-regression-pooling-years-in-the-model">c. Making year a number, polynomial regression, pooling years in the
model<a class="anchor" aria-label="anchor" href="#c--making-year-a-number-polynomial-regression-pooling-years-in-the-model"></a>
</h3>
<p>When there are too few observations in each year to estimate an
independent year effect, it may be desirable to make year a number
rather than a factor. If Year is listed in numericVariables, then the
model <em>y~Year</em> is a linear regression with year. It also works to
put in year squared and year cubed terms,
e.g. <em>y~Year+area+fleet+I(Year<sup>2)+I(Year</sup>3)</em>, and let
the information criteria select the best model. This allows for fitting
trends with complex shapes, but estimating a smaller number of
parameters. The R function I() is needed for calculations inside an R
formula, such as squaring, so the code understands it correctly.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The code automatically converts variables listed in numericVariables to numeric, but you can also do that yourself, with this R code</span></span>
<span><span class="va">obsdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">obsdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">logdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">logdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#Year must be in numericVariables in setupObj</span></span>
<span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"numYear"</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">Year</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">Year</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>, <span class="co">#Year is still in formula, now with polynomial</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>, </span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,   </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this case, the information criteria included a squared term.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Resultsnbinom</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"OutputLLSIMBUM/Bluemarlincatch/Fit files/BluemarlincatchnumYearTMBnbinom2AnnualSummary.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Resultsnbinom</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">Total</span>,ymin<span class="op">=</span><span class="va">TotalLCI</span>,ymax<span class="op">=</span><span class="va">TotalUCI</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p>Another method that might be useful for bycatch estimation with small
sample sizes is to not include year in the model. The estimates will
still be annual, but the model doesn’t necessarily need to include year.
The following tests a two year time block, and also allows the model to
estimate a null model by setting simpleModel=formula(y~1).</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Make new variable for the 2 year time block</span></span>
<span><span class="va">obsdatTest</span><span class="op">$</span><span class="va">Year2</span><span class="op">&lt;-</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">trunc</a></span><span class="op">(</span><span class="va">obsdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">logdatTest</span><span class="op">$</span><span class="va">Year2</span><span class="op">&lt;-</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">trunc</a></span><span class="op">(</span><span class="va">logdatTest</span><span class="op">$</span><span class="va">Year</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>, <span class="co">#Keep year in the inputs because effort will be expanded by year</span></span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SWO"</span>,<span class="st">"BUM"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co">#choosing only one species</span></span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>, </span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>, </span>
<span>  logNum <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"Year2"</span>,<span class="st">"area"</span>,<span class="st">"fleet"</span><span class="op">)</span>, <span class="co">#Two year time blocks now used as a variable. Include Year as a factor although it is not used in the models</span></span>
<span>  numericVariables <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  EstimateBycatch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUM2year"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIMBUM 2 year blocks"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swordfish"</span>,<span class="st">"Blue marlin"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co">#choosing only one species</span></span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xiphias gladius"</span>,<span class="st">"Makaira nigricans"</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="co">#choosing only one species</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"2year"</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year2</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">)</span>, <span class="co">#Year is not in the formula</span></span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span>, <span class="co">#Even Year2 not needed in formula </span></span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,   </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As you can see in the output html file, the best model is now the one
that has the year2 variable, which is estimating a single coefficient
for each 2 year block. There is still a different bycatch estimate for
each year, because each year has a different total effort, and a
different distribution of the other variables, effort and fleet.</p>
</div>
<div class="section level3">
<h3 id="d--validation-data-">d. Validation data.<a class="anchor" aria-label="anchor" href="#d--validation-data-"></a>
</h3>
<p>With simulated data you can compare the estimated total bycatch to
true total bycatch, as we will do here. With real data, you can use the
tool to predict total landed catch as a test of the methodology. The
validation data must be in a dataframe, and input in bycatchFit using
the settings in bycatchFit:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trueVals</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"TotalAnnualCatches.csv"</span><span class="op">)</span> <span class="co">#read in validation data</span></span>
<span><span class="va">trueVals</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trueVals</span>,<span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span> <span class="co">#filter for years 2011 - 2015</span></span>
<span></span>
<span><span class="va">setupObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bycatchSetup.html">bycatchSetup</a></span><span class="op">(</span></span>
<span>  obsdat <span class="op">=</span> <span class="va">obsdatTest</span>,</span>
<span>  logdat <span class="op">=</span> <span class="va">logdatTest</span>,</span>
<span>  yearVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  obsEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  logEffort <span class="op">=</span> <span class="st">"hooks"</span>,</span>
<span>  obsCatch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BUM"</span>,<span class="st">"SWO"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  catchUnit <span class="op">=</span> <span class="st">"number"</span>, </span>
<span>  catchType <span class="op">=</span> <span class="st">"catch"</span>,  </span>
<span>  sampleUnit <span class="op">=</span> <span class="st">"trips"</span>,</span>
<span>  logNum <span class="op">=</span>  <span class="cn">NA</span>,</span>
<span>  factorVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>,<span class="st">"fleet"</span>,<span class="st">"area"</span><span class="op">)</span>,</span>
<span>  numericVariables <span class="op">=</span>  <span class="cn">NULL</span>,</span>
<span>  runName <span class="op">=</span> <span class="st">"LLSIMBUMVal"</span>,</span>
<span>  runDescription <span class="op">=</span> <span class="st">"LLSIm BUM Validate"</span>,</span>
<span>  common <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Blue marlin"</span>,<span class="st">"Swordfish"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>  sp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Makaira nigricans"</span>,<span class="st">"Xiphias gladius"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> , </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/bycatchFit.html">bycatchFit</a></span><span class="op">(</span></span>
<span>  <span class="va">setupObj</span>,</span>
<span>  modelScenario <span class="op">=</span> <span class="st">"val"</span>,</span>
<span>  complexModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">+</span><span class="va">area</span><span class="op">+</span><span class="va">fleet</span><span class="op">)</span>, </span>
<span>  simpleModel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>  modelTry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TMBdelta-Lognormal"</span>,<span class="st">"TMBnbinom2"</span><span class="op">)</span>,</span>
<span>  selectCriteria <span class="op">=</span> <span class="st">"BIC"</span>,</span>
<span>  DoCrossValidation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  CIval <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  VarCalc <span class="op">=</span> <span class="st">"DeltaMethod"</span>,</span>
<span>  useParallel <span class="op">=</span> <span class="cn">TRUE</span>,  </span>
<span>  nSims <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  plotValidation <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co">#Make this true to include validation data in the plot</span></span>
<span>  trueVals <span class="op">=</span> <span class="va">trueVals</span>,  <span class="co">#Include the name of the data frame with the validation data (annual only)</span></span>
<span>  trueCols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Total.BUM"</span>,<span class="st">"Total.SWO"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,  <span class="co">#Names of columns in trueVals.</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The Validation data points are now plotted as points in figure 1 of
the html output.</p>
</div>
<div class="section level3">
<h3 id="e--reading-in-the-r-objects-in-the--rds-files">e. Reading in the R objects in the .rds files<a class="anchor" aria-label="anchor" href="#e--reading-in-the-r-objects-in-the--rds-files"></a>
</h3>
<p>The .rds files output by bycatchSetup, bycatchDesign and bycatchFit
can be read into R directly using the readRDS function. There is also a
helper function in the BycatchEstimator package called loadInputs, which
lets you read in all these .rds files and extract the information into
your R environment.</p>
<p>This function takes as inputs, baseDir, the runName, runDate
(defaults to the current date), and character vectors listing the
scenarios you want read in, designScenarios and modelScenarios. Set to
NULL to not read in any scenarios. The function returns a list with the
setupObj from the specified run, a list called designObjList which
contains the design-based model inputs and outputs for each
designScenario, modelObjList, which is the same for the models in
modelScenarios, and a data frame called allYearEstimates which is the
annual estimates across all design-based and model-based scenarios in a
format suitable for ggplot</p>
<p>To demonstrate, we will first run bycatchDesign to get some design
results, then use loadInputs to get all the results and plot the
design-based and model-based bycatch estimates together. This is based
on the example code in the user’s guide.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Run some design-based estimates</span></span>
<span><span class="fu"><a href="../reference/bycatchDesign.html">bycatchDesign</a></span><span class="op">(</span></span>
<span>  setupObj <span class="op">=</span> <span class="va">setupObj</span>,</span>
<span>  designScenario<span class="op">=</span><span class="st">"noPool"</span>,</span>
<span>  designMethods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ratio"</span>,<span class="st">"Delta"</span><span class="op">)</span>,</span>
<span>  designVars <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  groupVar <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  designPooling <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  poolTypes <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pooledVar <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  adjacentNum <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  minStrataUnit <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  reportType <span class="op">=</span> <span class="st">"html"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#Load in both design and model based estimates</span></span>
<span><span class="va">outputObj</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/loadOutputs.html">loadOutputs</a></span><span class="op">(</span>baseDir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      runName<span class="op">=</span> <span class="st">"LLSIMBUMVal"</span>,</span>
<span>                      runDate <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      designScenarios <span class="op">=</span> <span class="st">"noPool"</span>,</span>
<span>                      modelScenarios <span class="op">=</span> <span class="st">"val"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#Plot all together</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">outputObj</span><span class="op">$</span><span class="va">allYearEstimates</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Year</span>,y<span class="op">=</span><span class="va">Total</span>,</span>
<span>                                       ymin<span class="op">=</span><span class="va">TotalLCI</span>,ymax<span class="op">=</span><span class="va">TotalUCI</span>,</span>
<span>                      fill<span class="op">=</span><span class="va">Source</span>,color<span class="op">=</span><span class="va">Source</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Elizabeth Babcock, William Harford, Ana Adao.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
